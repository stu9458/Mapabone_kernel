From 62ee54b8a0e972d4194714d8c2feb346ac0dac1a Mon Sep 17 00:00:00 2001
From: Robert Nelson <robertcnelson@gmail.com>
Date: Thu, 21 Aug 2014 10:20:26 -0500
Subject: [PATCH 17/17] am335x-bone-common: pinmux hdmi audio

Signed-off-by: Robert Nelson <robertcnelson@gmail.com>
---
 arch/arm/boot/dts/am335x-bone-common-pinmux.dtsi   | 10 ++++
 .../boot/dts/am335x-boneblack-nxp-hdmi-audio.dtsi  | 66 ++++++++++++++++++++++
 arch/arm/boot/dts/am335x-boneblack.dts             |  4 +-
 3 files changed, 79 insertions(+), 1 deletion(-)
 create mode 100644 arch/arm/boot/dts/am335x-boneblack-nxp-hdmi-audio.dtsi

diff --git a/arch/arm/boot/dts/am335x-bone-common-pinmux.dtsi b/arch/arm/boot/dts/am335x-bone-common-pinmux.dtsi
index 827a9f2..cc9c15a 100644
--- a/arch/arm/boot/dts/am335x-bone-common-pinmux.dtsi
+++ b/arch/arm/boot/dts/am335x-bone-common-pinmux.dtsi
@@ -217,6 +217,16 @@
 		>;
 	};
 
+	mcasp0_pins: mcasp0_pins {
+		pinctrl-single,pins = <
+			0x1ac (PIN_INPUT_PULLUP | MUX_MODE0)    /* mcasp0_ahclkx.mcasp0_ahclkx */
+			0x19c (PIN_OUTPUT_PULLDOWN | MUX_MODE2) /* mcasp0_ahclkr.mcasp0_axr2 */
+			0x194 (PIN_OUTPUT_PULLUP | MUX_MODE0)   /* mcasp0_fsx.mcasp0_fsx */
+			0x190 (PIN_OUTPUT_PULLDOWN | MUX_MODE0) /* mcasp0_aclkx.mcasp0_aclkx */
+			0x06c (PIN_OUTPUT_PULLDOWN | MUX_MODE7) /* gpmc_a11.GPIO1_27 */
+		>;
+	};
+
 	mcasp0_pins_audio: mcasp0_pins_audio {
 		pinctrl-single,pins = <
 			0x1ac 0x00	/* mcasp0_ahclkx, OUTPUT | MODE0, Codec MCLK */
diff --git a/arch/arm/boot/dts/am335x-boneblack-nxp-hdmi-audio.dtsi b/arch/arm/boot/dts/am335x-boneblack-nxp-hdmi-audio.dtsi
new file mode 100644
index 0000000..9a3c163
--- /dev/null
+++ b/arch/arm/boot/dts/am335x-boneblack-nxp-hdmi-audio.dtsi
@@ -0,0 +1,66 @@
+/*
+ * Copyright (C) 2012 Texas Instruments Incorporated - http://www.ti.com/
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ */
+
+&lcdc {
+	status = "okay";
+};
+
+&mcasp0        {
+	pinctrl-names = "default";
+	pinctrl-0 = <&mcasp0_pins>;
+	status = "okay";
+	op-mode = <0>;  /* MCASP_IIS_MODE */
+	tdm-slots = <2>;
+	serial-dir = <  /* 0: INACTIVE, 1: TX, 2: RX */
+			0 0 1 0
+		>;
+	tx-num-evt = <1>;
+	rx-num-evt = <1>;
+};
+
+&ext_clocks {
+	clk_mcasp0_fixed: clk_mcasp0_fixed {
+		#clock-cells = <0>;
+		compatible = "fixed-clock";
+		clock-frequency = <24576000>;
+	};
+
+	clk_mcasp0: clk_mcasp0 {
+		#clock-cells = <0>;
+		compatible = "ti,gpio-clock";
+		clocks = <&clk_mcasp0_fixed>;
+		enable-gpios = <&gpio1 27 0>; /* BeagleBone Black Clk enable on GPIO1_27 */
+	};
+};
+
+/ {
+	hdmi {
+		compatible = "ti,tilcdc,slave";
+		i2c = <&i2c0>;
+		pinctrl-names = "default", "off";
+		pinctrl-0 = <&nxp_hdmi_bonelt_pins>;
+		pinctrl-1 = <&nxp_hdmi_bonelt_off_pins>;
+		status = "okay";
+	};
+
+	hdmi_audio: hdmi_audio@0 {
+		compatible = "linux,hdmi-audio";
+		status = "okay";
+	};
+
+	sound {
+		compatible = "ti,am335x-beaglebone-black-audio";
+		ti,model = "TI BeagleBone Black";
+		ti,audio-codec = <&hdmi_audio>;
+		ti,mcasp-controller = <&mcasp0>;
+		ti,audio-routing =
+			"HDMI Out",     "TX";
+		clocks = <&clk_mcasp0>;
+		clock-names = "mclk";
+	};
+};
diff --git a/arch/arm/boot/dts/am335x-boneblack.dts b/arch/arm/boot/dts/am335x-boneblack.dts
index 3b7dbdb..03aa060 100644
--- a/arch/arm/boot/dts/am335x-boneblack.dts
+++ b/arch/arm/boot/dts/am335x-boneblack.dts
@@ -41,7 +41,9 @@
 /* #include "am335x-bone-ttyO5.dtsi" */
 
 /* Display */
-#include "am335x-boneblack-nxp-hdmi-no-audio.dtsi"
+/* #include "am335x-boneblack-nxp-hdmi-no-audio.dtsi" */
+/* Pins: audio: P9.25, P9.28, P9.29, P9.30, P9.31 */
+#include "am335x-boneblack-nxp-hdmi-audio.dtsi"
 
 /* Capes */
 /* http://elinux.org/4D_4.3_LCD_CAPE */
-- 
2.1.0

